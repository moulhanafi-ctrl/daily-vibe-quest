# Load Testing Plan & Results
**Date:** January 22, 2025  
**Tool:** Artillery / k6  
**App Version:** 2025-10-15-chat-fix  
**Target Load:** 100+ concurrent users  

## Executive Summary
| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Concurrent Users | 100 | - | ⏳ NOT TESTED |
| Avg Response Time | <500ms | - | ⏳ |
| Peak Response Time | <2s | - | ⏳ |
| Error Rate | <1% | - | ⏳ |
| Requests/sec | 50+ | - | ⏳ |
| Database Connections | <50 | - | ⏳ |

**Overall Status:** ❌ NOT TESTED

---

## Load Test Scenarios

### Scenario 1: Authentication Load
**Priority:** P0  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
config:
  target: "https://2c588c7a-e9e9-4d3f-b2dd-79a1b8546184.lovableproject.com"
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Ramp up to 50 users"
    - duration: 120
      arrivalRate: 20
      name: "Sustain 100 concurrent users"
    - duration: 60
      arrivalRate: 5
      name: "Ramp down"

scenarios:
  - name: "User Signup and Login"
    weight: 1
    flow:
      - post:
          url: "/auth"
          json:
            email: "test{{ $randomNumber }}@example.com"
            password: "P@ssw0rd!2025"
            username: "user{{ $randomNumber }}"
            age_group: "adult"
      - think: 2
      - post:
          url: "/auth/login"
          json:
            email: "{{ email }}"
            password: "{{ password }}"
```

#### Expected Results
- Supabase Auth should handle 100+ signups/logins per minute
- Response times <1s for auth operations
- No auth token collisions
- No database connection pool exhaustion

#### Actual Results
- **Total Requests:** -
- **Successful:** -
- **Failed:** -
- **Avg Response Time:** -
- **P95 Response Time:** -
- **P99 Response Time:** -
- **Errors:** -

---

### Scenario 2: Dashboard & Check-in Load
**Priority:** P0  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
scenarios:
  - name: "Dashboard Load and Mood Check-in"
    weight: 1
    flow:
      - post:
          url: "/auth/login"
          json:
            email: "{{ email }}"
            password: "{{ password }}"
      - think: 1
      - get:
          url: "/dashboard"
      - think: 3
      - post:
          url: "/api/mood-checkins"
          json:
            mood: "{{ $randomNumber(1, 5) }}"
            notes: "Feeling {{ $randomString() }}"
      - think: 2
      - get:
          url: "/journal"
```

#### Expected Results
- Dashboard loads <500ms with 100 users
- Check-in submissions process in <1s
- Database writes queue properly
- No transaction deadlocks

#### Actual Results
- **Total Requests:** -
- **Successful:** -
- **Failed:** -
- **Avg Response Time:** -
- **Database Connections:** -
- **Errors:** -

---

### Scenario 3: Chat Room Realtime Load
**Priority:** P0  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
scenarios:
  - name: "Chat Room Activity"
    weight: 1
    flow:
      - post:
          url: "/auth/login"
          json:
            email: "{{ email }}"
            password: "{{ password }}"
      - think: 1
      - get:
          url: "/chat-rooms"
      - think: 2
      - ws:
          url: "wss://{{ target }}/chat-room/{{ roomId }}"
          send:
            message: "Hello from user {{ $randomNumber }}"
          on:
            message: "{{ validateMessage }}"
      - think: 5
      - ws:
          send:
            message: "Another message {{ $randomString }}"
```

#### Expected Results
- 100 concurrent WebSocket connections stable
- Message delivery <500ms
- Supabase Realtime handles broadcast load
- No connection drops
- Profanity edge function handles message rate

#### Actual Results
- **Concurrent Connections:** -
- **Messages Sent:** -
- **Messages Delivered:** -
- **Avg Delivery Time:** -
- **Connection Drops:** -
- **Edge Function Invocations:** -
- **Edge Function Errors:** -

---

### Scenario 4: Store & Checkout Load
**Priority:** P0  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
scenarios:
  - name: "Store Browsing and Checkout"
    weight: 1
    flow:
      - post:
          url: "/auth/login"
      - think: 2
      - get:
          url: "/store"
      - think: 3
      - get:
          url: "/store/adults"
      - think: 4
      - get:
          url: "/product/{{ productId }}"
      - think: 2
      - post:
          url: "/api/cart"
          json:
            productId: "{{ productId }}"
            quantity: 1
      - think: 3
      - post:
          url: "/api/create-checkout"
          json:
            items: ["{{ productId }}"]
```

#### Expected Results
- Store pages load <1s
- Product queries optimized
- Stripe checkout sessions create <2s
- No payment conflicts
- Edge function scales with load

#### Actual Results
- **Store Page Load:** -
- **Product Detail Load:** -
- **Checkout Session Creation:** -
- **Stripe API Response Time:** -
- **Edge Function Success Rate:** -

---

### Scenario 5: Journal & AI Load
**Priority:** P1  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
scenarios:
  - name: "Journal Entry and AI Suggestions"
    weight: 1
    flow:
      - post:
          url: "/auth/login"
      - think: 2
      - get:
          url: "/journal"
      - think: 5
      - post:
          url: "/api/journal-entries"
          json:
            content: "{{ $randomParagraph }}"
            mood: "{{ $randomNumber(1, 5) }}"
      - think: 3
      - post:
          url: "/api/ai-suggestions"
          json:
            userId: "{{ userId }}"
            context: "journal"
```

#### Expected Results
- Journal entry creation <1s
- AI suggestions generate <3s
- Lovable AI API handles concurrent requests
- No rate limiting errors

#### Actual Results
- **Journal Entry Creation Time:** -
- **AI Suggestion Generation Time:** -
- **AI API Success Rate:** -
- **Rate Limit Errors:** -

---

### Scenario 6: Subscription Check Load
**Priority:** P0  
**Status:** ⏳ NOT TESTED

#### Configuration
```yaml
scenarios:
  - name: "Subscription Verification"
    weight: 1
    flow:
      - post:
          url: "/auth/login"
      - think: 1
      - post:
          url: "/api/check-subscription"
          headers:
            Authorization: "Bearer {{ token }}"
```

#### Expected Results
- Subscription checks <500ms
- Stripe API handles 100+ req/min
- Edge function caches results
- No rate limit errors from Stripe

#### Actual Results
- **Avg Check Time:** -
- **Stripe API Response:** -
- **Cache Hit Rate:** -
- **Errors:** -

---

## Database Load Testing

### Supabase Connection Pool
**Status:** ⏳ NOT TESTED

#### Metrics to Monitor
- Active connections
- Idle connections
- Connection queue depth
- Query execution time
- Transaction rate

#### Expected Limits
- Max connections: 50 (Supabase Free Tier)
- Avg connection time: <100ms
- Query time: <50ms (simple), <500ms (complex)

#### Actual Results
- **Peak Connections:** -
- **Avg Connection Time:** -
- **Query Performance:** -
- **Connection Errors:** -

---

### RLS Policy Performance
**Status:** ⏳ NOT TESTED

#### Tables to Test
1. `profiles` - User lookups
2. `mood_checkins` - Write-heavy
3. `journal_entries` - Write-heavy with auth.uid()
4. `chat_messages` - High-volume writes + realtime
5. `blocked_users` - Read-heavy in chat

#### Expected Results
- RLS overhead <10ms per query
- No full table scans
- Proper indexes on user_id columns

#### Actual Results
| Table | Queries/sec | Avg Query Time | Index Usage | Pass/Fail |
|-------|-------------|----------------|-------------|-----------|
| profiles | - | - | - | ⏳ |
| mood_checkins | - | - | - | ⏳ |
| journal_entries | - | - | - | ⏳ |
| chat_messages | - | - | - | ⏳ |
| blocked_users | - | - | - | ⏳ |

---

## Edge Function Load Testing

### Edge Function Performance
**Status:** ⏳ NOT TESTED

#### Functions to Test
1. `check-subscription` - High frequency
2. `check-profanity` - Per chat message
3. `mindful-ai-assistant` - AI generation
4. `create-checkout` - Payment creation
5. `generate-ai-suggestions` - AI generation

#### Expected Results
- Cold start <1s
- Warm execution <300ms
- No timeout errors (10s limit)
- Concurrent execution handled

#### Actual Results
| Function | Invocations | Avg Time | Cold Starts | Timeouts | Errors |
|----------|-------------|----------|-------------|----------|--------|
| check-subscription | - | - | - | - | - |
| check-profanity | - | - | - | - | - |
| mindful-ai-assistant | - | - | - | - | - |
| create-checkout | - | - | - | - | - |
| generate-ai-suggestions | - | - | - | - | - |

---

## Realtime Subscriptions Load

### Supabase Realtime Performance
**Status:** ⏳ NOT TESTED

#### Test Setup
- 100 users subscribe to `chat_messages` table
- 50 users actively sending messages (1 msg/5 seconds)
- Monitor broadcast latency and connection stability

#### Expected Results
- Message delivery <500ms
- No dropped messages
- No connection failures
- Broadcast scales to 100+ subscribers

#### Actual Results
- **Concurrent Subscriptions:** -
- **Messages Broadcast:** -
- **Avg Delivery Time:** -
- **Dropped Messages:** -
- **Connection Failures:** -

---

## External API Load

### Stripe API Load
**Status:** ⏳ NOT TESTED

#### Endpoints Tested
1. `customers.list` - User lookup
2. `subscriptions.list` - Subscription check
3. `checkout.sessions.create` - Checkout creation
4. `billingPortal.sessions.create` - Portal access

#### Expected Results
- API response time <1s
- No rate limit errors (100 req/sec limit)
- Proper error handling for failures

#### Actual Results
| Endpoint | Requests | Avg Time | Rate Limits | Errors |
|----------|----------|----------|-------------|--------|
| customers.list | - | - | - | - |
| subscriptions.list | - | - | - | - |
| checkout.sessions.create | - | - | - | - |
| billingPortal.sessions.create | - | - | - | - |

---

### Lovable AI API Load
**Status:** ⏳ NOT TESTED

#### Models Tested
- `google/gemini-2.5-flash` - Fast, moderate complexity
- `openai/gpt-5-mini` - Balanced performance

#### Expected Results
- Generation time <5s
- No token limit errors
- Concurrent requests handled

#### Actual Results
| Model | Requests | Avg Time | Tokens | Errors |
|-------|----------|----------|--------|--------|
| gemini-2.5-flash | - | - | - | - |
| gpt-5-mini | - | - | - | - |

---

## Stress Testing

### Peak Load Scenario
**Status:** ⏳ NOT TESTED

#### Configuration
- Ramp to 200 concurrent users over 5 minutes
- Sustain for 10 minutes
- Monitor for failures

#### Expected Results
- System gracefully degrades
- No cascading failures
- Error rate <5%
- Recovery time <1 minute after load decrease

#### Actual Results
- **Peak Concurrent Users:** -
- **Error Rate at Peak:** -
- **System Recovery Time:** -
- **Critical Failures:** -

---

### Soak Testing (Long Duration)
**Status:** ⏳ NOT TESTED

#### Configuration
- 50 concurrent users
- Run for 4 hours
- Monitor memory leaks and connection leaks

#### Expected Results
- Memory usage stable (<500MB)
- No connection leaks
- No database connection exhaustion
- No edge function cold start increase

#### Actual Results
- **Duration:** -
- **Memory Growth:** -
- **Connection Leaks:** -
- **Performance Degradation:** -

---

## Spike Testing

### Sudden Traffic Surge
**Status:** ⏳ NOT TESTED

#### Configuration
- Baseline: 10 users
- Spike to 150 users in 30 seconds
- Sustain for 2 minutes
- Drop back to baseline

#### Expected Results
- Auto-scaling responds within 1 minute
- Error rate <10% during spike
- Recovery to normal within 30 seconds

#### Actual Results
- **Spike Response Time:** -
- **Error Rate During Spike:** -
- **Recovery Time:** -

---

## Artillery Test Script

### Sample Artillery YAML
```yaml
config:
  target: "https://2c588c7a-e9e9-4d3f-b2dd-79a1b8546184.lovableproject.com"
  phases:
    - duration: 60
      arrivalRate: 5
      name: "Warm up"
    - duration: 120
      arrivalRate: 10
      name: "Ramp to 50 users"
    - duration: 300
      arrivalRate: 20
      name: "Sustain 100 users"
    - duration: 60
      arrivalRate: 5
      name: "Ramp down"
  processor: "./test-processor.js"
  variables:
    testEmails:
      - "loadtest1@example.com"
      - "loadtest2@example.com"
      - "loadtest3@example.com"

scenarios:
  - name: "Full User Journey"
    weight: 1
    flow:
      # Auth
      - post:
          url: "/auth/login"
          json:
            email: "{{ $randomString }}@loadtest.com"
            password: "P@ssw0rd!2025"
          capture:
            - json: "$.access_token"
              as: "token"
      - think: 2

      # Dashboard
      - get:
          url: "/dashboard"
          headers:
            Authorization: "Bearer {{ token }}"
      - think: 3

      # Mood Check-in
      - post:
          url: "/api/mood-checkins"
          headers:
            Authorization: "Bearer {{ token }}"
          json:
            mood: "{{ $randomNumber(1, 5) }}"
            notes: "Load test check-in"
      - think: 2

      # Journal
      - post:
          url: "/api/journal-entries"
          headers:
            Authorization: "Bearer {{ token }}"
          json:
            content: "This is a load test journal entry with some random text."
      - think: 5

      # Store
      - get:
          url: "/store"
          headers:
            Authorization: "Bearer {{ token }}"
      - think: 3

      # Subscription Check
      - post:
          url: "/api/check-subscription"
          headers:
            Authorization: "Bearer {{ token }}"
      - think: 1
```

### Run Commands
```bash
# Install Artillery
npm install -g artillery

# Run load test
artillery run load-test-config.yml

# Generate HTML report
artillery run load-test-config.yml --output report.json
artillery report report.json

# Quick test
artillery quick --count 10 --num 100 https://[YOUR_APP_URL]
```

---

## k6 Alternative Script

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '1m', target: 20 },
    { duration: '3m', target: 100 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    errors: ['rate<0.1'],
  },
};

export default function () {
  const BASE_URL = 'https://2c588c7a-e9e9-4d3f-b2dd-79a1b8546184.lovableproject.com';
  
  // Login
  const loginRes = http.post(`${BASE_URL}/auth/login`, JSON.stringify({
    email: `test${__VU}@example.com`,
    password: 'P@ssw0rd!2025',
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(loginRes, {
    'login successful': (r) => r.status === 200,
  }) || errorRate.add(1);
  
  sleep(1);
  
  // Dashboard
  const dashRes = http.get(`${BASE_URL}/dashboard`, {
    headers: { Authorization: `Bearer ${loginRes.json('access_token')}` },
  });
  
  check(dashRes, {
    'dashboard loaded': (r) => r.status === 200,
  }) || errorRate.add(1);
  
  sleep(2);
  
  // Mood Check-in
  const checkInRes = http.post(`${BASE_URL}/api/mood-checkins`, JSON.stringify({
    mood: Math.floor(Math.random() * 5) + 1,
    notes: 'Load test check-in',
  }), {
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${loginRes.json('access_token')}`,
    },
  });
  
  check(checkInRes, {
    'check-in successful': (r) => r.status === 201,
  }) || errorRate.add(1);
  
  sleep(3);
}
```

---

## Monitoring During Load Test

### Key Metrics to Watch
1. **Response Times** (Target: P95 <500ms)
2. **Error Rate** (Target: <1%)
3. **Database Connections** (Target: <50)
4. **Edge Function Cold Starts** (Target: <5%)
5. **Memory Usage** (Target: Stable)
6. **CPU Usage** (Target: <80%)

### Monitoring Tools
- Supabase Dashboard (Database metrics)
- Supabase Logs (Edge function logs)
- Browser DevTools (Network, Performance)
- Artillery/k6 Reports
- Sentry (Error tracking)
- PostHog (User behavior during load)

---

## Issues & Bottlenecks

### Potential Bottlenecks to Monitor
1. **Database Connection Pool** - Supabase Free Tier limit
2. **Edge Function Cold Starts** - First invocation delay
3. **Stripe API Rate Limits** - 100 req/sec
4. **Lovable AI Quotas** - Token limits
5. **Realtime Broadcast** - Message delivery latency
6. **Profanity Filter** - Edge function on every message

### Optimization Recommendations
- [ ] Implement connection pooling in edge functions
- [ ] Cache subscription checks (Redis or in-memory)
- [ ] Batch database writes where possible
- [ ] Use database indexes on frequently queried columns
- [ ] Optimize RLS policies
- [ ] Implement rate limiting on client side
- [ ] Add CDN for static assets

---

## Summary

**Testing Status:** ❌ NOT STARTED  
**Estimated Testing Time:** 4-6 hours  
**Tools Required:** Artillery or k6, Supabase Dashboard access  

**Next Steps:**
1. Set up Artillery/k6 environment
2. Create test user accounts (100+)
3. Run baseline tests with 10 users
4. Gradually increase to 50, then 100 concurrent users
5. Monitor database and edge function metrics
6. Document bottlenecks and performance issues
7. Optimize critical paths
8. Retest with improvements
9. Generate final load test report

**Critical P0 Scenarios:**
- ✅ Authentication Load
- ✅ Chat Realtime Load
- ✅ Subscription Checks
- ✅ Store Checkout

**Expected Completion:** After E2E and device testing complete
