<!DOCTYPE html>
<html>
<head>
  <title>Test US & CA ZIP/Postal Codes</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
    button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
    .result { margin: 20px 0; padding: 15px; background: #2a2a2a; border-left: 4px solid #4CAF50; }
    .error { border-left-color: #f44336; }
    .loading { color: #ffa500; }
    pre { overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üß™ Test US & Canada ZIP/Postal Codes</h1>
  
  <div>
    <button onclick="testUS()">Test US: 48917 (Lansing, MI)</button>
    <button onclick="testCA()">Test Canada: M5H 2N2 (Toronto, ON)</button>
    <button onclick="testBoth()">Test Both üöÄ</button>
  </div>
  
  <div id="results"></div>

  <script>
    const SUPABASE_URL = 'https://hssrytzedacchvkrxgnq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzc3J5dHplZGFjY2h2a3J4Z25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwODA2NTEsImV4cCI6MjA3NTY1NjY1MX0.YBmt9RZQ3Oxw0LMg44CfyJwV2866wd2t8K6gf5vWMCA';

    function log(message, isError = false) {
      const div = document.createElement('div');
      div.className = 'result' + (isError ? ' error' : '');
      div.innerHTML = message;
      document.getElementById('results').appendChild(div);
    }

    async function testZipCode(code, country) {
      log(`<div class="loading">‚è≥ Testing ${code} (${country})...</div>`);
      
      const startTime = Date.now();
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/help-nearby`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            code: code,
            countryHint: country,
            radiusKm: 40,
            limit: 10
          })
        });

        const data = await response.json();
        const latency = Date.now() - startTime;

        if (!response.ok) {
          log(`<h3>‚ùå ${code} (${country}) - FAILED (${latency}ms)</h3>
            <pre>${JSON.stringify(data, null, 2)}</pre>`, true);
          return;
        }

        const providers = data.providers || [];
        const hotlines = data.nationalHotlines || [];
        
        log(`<h3>‚úÖ ${code} (${country}) - SUCCESS (${latency}ms)</h3>
          <strong>Location:</strong> ${data.location?.city || 'Unknown'}, ${data.location?.region || 'Unknown'}<br>
          <strong>Geocoder:</strong> ${data.geocoder || 'Unknown'}<br>
          <strong>Providers found:</strong> ${providers.length}<br>
          <strong>National hotlines:</strong> ${hotlines.length}<br>
          <details>
            <summary>View Full Response</summary>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </details>`);
        
        return data;
      } catch (error) {
        const latency = Date.now() - startTime;
        log(`<h3>‚ùå ${code} (${country}) - ERROR (${latency}ms)</h3>
          <pre>${error.message}</pre>`, true);
      }
    }

    async function testUS() {
      document.getElementById('results').innerHTML = '';
      await testZipCode('48917', 'US');
    }

    async function testCA() {
      document.getElementById('results').innerHTML = '';
      await testZipCode('M5H 2N2', 'CA');
    }

    async function testBoth() {
      document.getElementById('results').innerHTML = '';
      log('<h2>üß™ Running Full Test Suite</h2>');
      
      await testZipCode('48917', 'US');
      await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s between requests
      
      await testZipCode('M5H 2N2', 'CA');
      
      log('<h2>‚úÖ Test suite complete!</h2>');
    }
  </script>
</body>
</html>
